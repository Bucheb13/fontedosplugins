module.exports=[72580,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(49789);function e(a){return new Date(a).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"})}async function f(a){let b=await a.text();try{return b?JSON.parse(b):{}}catch{return{erro:b||"Resposta inválida do servidor"}}}function g(){let{senhaAdmin:a,setMensagem:g,setAcaoHeader:h}=(0,d.useAdmin)(),[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)(!1),[m,n]=(0,c.useState)(null),[o,p]=(0,c.useState)(null),[q,r]=(0,c.useState)(""),[s,t]=(0,c.useState)("mensal"),[u,v]=(0,c.useState)("ativa"),[w,x]=(0,c.useState)(!1),[y,z]=(0,c.useState)([]),A=(0,c.useCallback)(async()=>{if(g(null),!a)return void g("Digite a senha do admin.");l(!0);let b=await fetch("/api/admin/assinaturas/listar",{headers:{"x-senha-admin":a},cache:"no-store"}),c=await f(b);(l(!1),b.ok)?j(c.itens??[]):g(c?.erro??"Falha ao carregar assinaturas.")},[a,g]);(0,c.useEffect)(()=>(h({rotulo:"Carregar lista",carregando:k,aoClicar:A}),()=>h(null)),[h,k,A]),(0,c.useEffect)(()=>{a?(async()=>{try{let b=await fetch("/api/admin/assinaturas/listar?todosUsuarios=true",{headers:{"x-senha-admin":a},cache:"no-store"}),c=await f(b);if(!b.ok){g(c?.erro??"Falha ao carregar usuários."),z([]);return}let d=c.usuariosDisponiveis??[],e=new Set(i.map(a=>a.usuario_id)),h=d.filter(a=>!e.has(a.id));z(h)}catch(a){console.error(a),z([])}})():Promise.resolve().then(()=>z([]))},[a,i,g]);let B=(0,c.useCallback)(async()=>{if(!a)return g("Digite a senha do admin.");if(!q)return g("Selecione um usuário.");if(i.find(a=>a.usuario_id===q))return g("Usuário já possui assinatura.");x(!0);let b=null;if("ativa"===u){let a=new Date;a.setDate(a.getDate()+("mensal"===s?31:365)),b=a.toISOString()}let c=await fetch("/api/admin/assinaturas/atualizar",{method:"POST",headers:{"Content-Type":"application/json","x-senha-admin":a},body:JSON.stringify({usuarioId:q,status:u,tipo:"ativa"===u?s:null,periodo_fim:b})}),d=await f(c);if(x(!1),!c.ok)return g(d?.erro??"Falha ao criar assinatura.");let e=y.find(a=>a.id===q);j(a=>[...a,{id:Date.now().toString(),usuario_id:q,display_name:e?.display_name??null,status:u,tipo:"ativa"===u?s:null,periodo_fim:b,criado_em:new Date().toISOString()}]),g("Assinatura criada com sucesso."),r(""),t("mensal"),v("ativa"),z(a=>a.filter(a=>a.id!==q))},[a,q,s,u,i,g,y]),C=(0,c.useCallback)(async(b,c)=>{if(g(null),!a)return g("Digite a senha do admin.");n(b);let d=i.find(a=>a.usuario_id===b);if(!d)return;let e=c.status??d.status,h=c.tipo??d.tipo,k=d.periodo_fim;if("inativa"===e)h=null,k=null;else if("ativa"===e){let a=new Date;a.setDate(a.getDate()+("mensal"===h?31:365)),k=a.toISOString()}let l=await fetch("/api/admin/assinaturas/atualizar",{method:"POST",headers:{"Content-Type":"application/json","x-senha-admin":a},body:JSON.stringify({usuarioId:b,status:e,tipo:h,periodo_fim:k})}),m=await f(l);(n(null),l.ok)?(j(a=>a.map(a=>a.usuario_id===b?{...a,status:e,tipo:h,periodo_fim:k}:a)),g("Assinatura atualizada.")):g(m?.erro??"Falha ao atualizar assinatura.")},[a,g,i]),D=(0,c.useCallback)(async b=>{if(g(null),!a)return g("Digite a senha do admin.");p(b);let c=await fetch("/api/admin/assinaturas/redefinir-senha",{method:"POST",headers:{"Content-Type":"application/json","x-senha-admin":a},body:JSON.stringify({usuarioId:b})}),d=await f(c);(p(null),c.ok)?g("Email de redefinição de senha enviado."):g(d?.erro??"Falha ao enviar redefinição de senha.")},[a,g]);return(0,b.jsx)("div",{className:"flex flex-col gap-6",children:(0,b.jsxs)("section",{className:"rounded-3xl border border-white/10 bg-white/5 p-6 md:p-8",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-xl font-semibold",children:"Gerenciamento de assinaturas"}),(0,b.jsx)("p",{className:"mt-1 text-sm text-white/70",children:"Controle manual do status e tipo por usuário."})]}),(0,b.jsxs)("div",{className:"text-xs text-white/60",children:[i.length," itens"]})]}),(0,b.jsxs)("div",{className:"mt-5 rounded-2xl border border-white/10 bg-black/20 p-4 flex flex-col gap-2",children:[(0,b.jsx)("h3",{className:"font-semibold",children:"Criar nova assinatura"}),(0,b.jsxs)("select",{value:q,onChange:a=>r(a.target.value),disabled:!a||0===y.length,className:"rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs outline-none",children:[(0,b.jsx)("option",{value:"",children:0===y.length?"Nenhum usuário disponível":"Selecione um usuário"}),y.map(a=>(0,b.jsx)("option",{value:a.id,children:a.display_name?`${a.display_name} (${a.id})`:a.id},a.id))]}),(0,b.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,b.jsxs)("select",{value:s,onChange:a=>t(a.target.value),className:"rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs outline-none",children:[(0,b.jsx)("option",{value:"mensal",children:"mensal"}),(0,b.jsx)("option",{value:"anual",children:"anual"})]}),(0,b.jsxs)("select",{value:u,onChange:a=>v(a.target.value),className:"rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs outline-none",children:[(0,b.jsx)("option",{value:"ativa",children:"ativa"}),(0,b.jsx)("option",{value:"inativa",children:"inativa"})]}),(0,b.jsx)("button",{disabled:w||!q,onClick:B,className:"rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs outline-none hover:bg-black/40",children:w?"Criando…":"Criar"})]})]}),0===i.length?(0,b.jsxs)("div",{className:"mt-5 rounded-2xl border border-white/10 bg-black/20 p-6 text-sm text-white/70",children:["Nenhuma assinatura carregada ainda. Digite a senha no header e clique em"," ",(0,b.jsx)("b",{children:"Carregar lista"}),"."]}):(0,b.jsx)("div",{className:"mt-5 space-y-3",children:i.map(c=>{let d=!a||m===c.usuario_id||o===c.usuario_id;return(0,b.jsxs)("div",{className:"rounded-2xl border border-white/10 bg-black/20 p-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsxs)("div",{className:"text-sm font-semibold truncate",children:["Usuário:"," ",(0,b.jsx)("span",{className:"text-white/90",children:c.display_name||"Sem nome"})]}),(0,b.jsxs)("div",{className:"mt-1 grid gap-1 text-xs text-white/60",children:[(0,b.jsxs)("div",{children:["ID: ",c.usuario_id]}),(0,b.jsxs)("div",{children:["Criado: ",e(c.criado_em)]}),(0,b.jsxs)("div",{children:["Período fim: ",c.periodo_fim?e(c.periodo_fim):"sem data"]}),(0,b.jsxs)("div",{children:["Tipo atual: ","ativa"===c.status?c.tipo??"não definido":"—"]})]})]}),(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:["ativa"===c.status&&(0,b.jsxs)("select",{value:c.tipo??"",disabled:d,onChange:a=>void C(c.usuario_id,{tipo:a.target.value||null}),className:"rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs outline-none disabled:opacity-60",children:[(0,b.jsx)("option",{value:"mensal",children:"mensal"}),(0,b.jsx)("option",{value:"anual",children:"anual"})]}),(0,b.jsxs)("select",{value:c.status,disabled:d,onChange:a=>void C(c.usuario_id,{status:a.target.value}),className:"rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs outline-none disabled:opacity-60",children:[(0,b.jsx)("option",{value:"ativa",children:"ativa"}),(0,b.jsx)("option",{value:"inativa",children:"inativa"})]}),(0,b.jsx)("button",{disabled:d,onClick:()=>void D(c.usuario_id),className:"rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs outline-none disabled:opacity-60 hover:bg-black/40",children:o===c.usuario_id?"Enviando…":"Redefinir senha"})]})]},c.id)})})]})})}a.s(["default",()=>g])}];

//# sourceMappingURL=src_app_admin_assinaturas_page_tsx_d1672ff8._.js.map